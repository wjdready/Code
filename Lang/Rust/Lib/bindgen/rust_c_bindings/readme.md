

## 构建过程打印中间信息

```rust
// cargo build -vv

// 或者添加 cargo:warning={}
macro_rules! myprint {
    ($($tokens: tt)*) => {
        println!("cargo:warning={}", format!($($tokens)*))
    }
}
```

## rust use c lib

First `cargo new rust_c_bindings`

```toml
# Cargo.toml
[package]
name = "rust_c_bindings"
version = "0.1.0"
edition = "2024"

[dependencies]

[build-dependencies]
cc = "1.0"
bindgen = "0.72.0"
```

```rust
// main.rs
#![allow(unused)]
#![allow(non_camel_case_types)]
#![allow(non_upper_case_globals)]
#![allow(non_snake_case)]

include!(concat!(env!("OUT_DIR"), "/bindings.rs"));

fn main() {
    let result = unsafe { add(2, 3) };
    println!("2 + 3 = {}", result);
}

// build.rs
use std::env;
use std::path::PathBuf;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 配置编译 C 代码
    let mut builder = cc::Build::new();

    let builder = builder
        .file("c_src/add.c");

    builder.compile("add");

    let bindings = bindgen::Builder::default()
        .header("c_src/add.h")
        .generate()
        .expect("Unable to generate bindings");

    let out_path = PathBuf::from(env::var("OUT_DIR").unwrap());
    bindings
        .write_to_file(out_path.join("bindings.rs"))
        .expect("Couldn't write bindings!");

    Ok(())
}
```

```c
// c_src/add.c
int add(int a, int b)
{
    return a + b;
}

// c_src/add.h
#pragma once

int add(int a, int b);
```

## c use rust lib

First `cargo new rust_c_bindings`

```toml
# Cargo.toml
[package]
name = "rust_c_bindings"
version = "0.1.0"
edition = "2024"

[lib]
name = "rust2clib"
crate-type = ["cdylib"]

[dependencies]

[build-dependencies]
cbindgen = "0.29.0"

# cbindgen.toml
language = "C"
include_guard = "RUST_FFI_H"
autogen_warning = "/* Warning, this file is autogenerated by cbindgen. DO NOT EDIT */"
```

```rust
// src/lib.rs

#[unsafe(no_mangle)]
pub extern "C" fn rust_add(a: i32, b: i32) -> i32 {
    a + b
}

// build.rs
use std::env;
use std::path::PathBuf;

fn main() {
    
    let profile = env::var("PROFILE").unwrap();

    let cargo_dir = PathBuf::from(env::var("CARGO_MANIFEST_DIR").unwrap());
    let target_dir = cargo_dir.join("target").join(profile);

    // 生成头文件或者命令行直接生成
    // cbindgen --config cbindgen.toml --crate rust_c_bindings --output rust2clib.h

    let config_path = cargo_dir.join("cbindgen.toml");
    let config = cbindgen::Config::from_file(config_path).expect("Failed to load cbindgen.toml");

    let header_path = target_dir.join("include").join("rust2clib.h");
    cbindgen::generate_with_config(&cargo_dir, config)
        .expect("Unable to generate bindings")
        .write_to_file(&header_path);
}
```

