
## PHY 接口

https://zhuanlan.zhihu.com/p/633454921?utm_id=0


1. MII（Media Independent Interface）即媒体独立接口，MII 接口是 MAC 与 PHY 连接的标准接口。

| 信号     | 方向         | 描述         |
| -------- | ------------ | ------------ |
| TX_CLK   | MAC ---> PHY | 发送时钟     |
| TXD[3:0] | MAC ---> PHY | 发送数据     |
| TX_ER    | MAC ---> PHY | 发送数据错误 |
| TX_EN    | MAC ---> PHY | 发送使能     |
| RX_CLK   | MAC ---> PHY | 接收时钟     |
| RXD[3:0] | MAC <--- PHY | 接收数据     |
| RX_ER    | MAC <--- PHY | 接收数据错误 |
| RX_DV    | MAC <--- PHY | 接收数据有效 |
| CRS      | MAC <--- PHY | 载波监测     |
| COL      | MAC <--- PHY | 冲突碰撞监测 |
| MDIO     | MAC <--> PHY | 管理数据     |
| MDC      | MAC ---> PHY | 管理数据时钟 |


2. RMII 是 MII 接口的简化版, RMII 只用两根线来传输数据, 相对应的需要提高 CLK 的频率

对于10Mbps 线速，MII 的时钟速率是 2.5MHz 就可以了，RMII 则需要 5MHz；对于 100Mbps 线速，MII 需要的时钟速率是 25MHz，RMII 则是 50MHz


3. GMII 是千兆网的 MII 接口

| 信号     | 方向         | 描述             |
| -------- | ------------ | ---------------- |
| GTX_CLK  | MAC ---> PHY | 1000M 发送时钟   |
| TX_CLK   | MAC ---> PHY | 100/10M 发送时钟 |
| TXD[7:0] | MAC ---> PHY | 发送数据         |
| TX_ER    | MAC ---> PHY | 发送数据错误     |
| TX_EN    | MAC ---> PHY | 发送使能         |
| RX_CLK   | MAC ---> PHY | 接收时钟         |
| RXD[7:0] | MAC <--- PHY | 接收数据         |
| RX_ER    | MAC <--- PHY | 接收数据错误     |
| RX_DV    | MAC <--- PHY | 接收数据有效     |
| CRS      | MAC <--- PHY | 载波监测         |
| COL      | MAC <--- PHY | 冲突碰撞监测     |
| MDIO     | MAC <--> PHY | 管理数据         |
| MDC      | MAC ---> PHY | 管理数据时钟     |


RGMII 是 GMII 接口的简化版

| 信号     | 方向         | 描述         |
| -------- | ------------ | ------------ |
| TXC      | MAC ---> PHY | 发送时钟     |
| TXC_CTL  | MAC ---> PHY | 发送数据控制 |
| TXD[3:0] | MAC ---> PHY | 发送数据     |
| RXC      | MAC <--- PHY | 接收时钟 |
| RXC_CTL  | MAC <--- PHY | 接收数据控制     |
| RXD[3:0] | MAC <--- PHY | 接收数据     |
| MDIO     | MAC <--> PHY | 管理数据     |
| MDC      | MAC ---> PHY | 管理数据时钟 |


虽然 RGMII 信号线减半，但 TXC/RXC 时钟仍为125Mhz，为了达到 1000Mbit 的传输速率，TXD/RXD 信号线在时钟上升沿发送/接收 GMII 接口中的 TXD[3:0]/RXD[3:0]，在时钟下降沿发送接收TXD[7:4]/RXD[7:4], 并且信号 TX_CTL 反应了 TX_EN 和 TX_ER 状态，即在 TXC 上升沿发送 TX_EN, 下降沿发送 TX_ER，同样的道理试用于 RX_CTL

## MAC 帧协议

以太网数据帧结构

| 前同步码 | 分隔符 | 目的地址 | 源地址  | 长度/类型   | 数据和填充   | 校验字段 |
| -------- | ------ | -------- | ------- | ----------- | ------------ | -------- |
| Preamble | SFD    | DES_MAC  | SRC_MAC | length/type | Data and Pad | FCS      |
| 7 字节   | 1 字节 | 6 字节   | 6 字节  | 2 字节      | 46~1500 字节 | 4 字节   |

每个字段说明

|                             |         |                                              |
| --------------------------- | ------- | -------------------------------------------- |
| 前导码（Preamble）          | 7       | 7 个字节的 0x55，用于帧的同步                |
| 帧开始符（SFD）             | 1       | 值为 0xd5，标明下一个字节为目的 MAC 字段     |
| 目的 MAC 地址               | 6       | 指明该以太网帧的接收方网卡地址               |
| 源 MAC 地址                 | 6       | 标记该以太网帧的发送方网卡的地址             |
| 长度/类型  （Length/ Type） | 2       | 当这两个字节的值小于 1518 时，那么它就代表其 |
|                             |         | 后数据字段的长度；如果这两个字节的值大于     |
|                             |         | 1518，则表示该以太网帧中的数据属于哪个上层协 |
|                             |         | 议（例如 0x800，代表 IP 数据包；0x806，代表  |
|                             |         | ARP 数据包等。                               |
| 数据和填充 （Data and Pad） | 46~1500 | 高层的数据，通常为 3 层协议数据单元。对于    |
|                             |         | UDP、TCP/IP 协议，该部分为 IP 数据包         |
| 帧校验序列（FCS）           | 4       | 对接收网卡提供判断是否传输错误的一种方法，如 |
|                             |         | 果发现错误，丢弃此帧，使用 CRC32 计算方法。  |

#### 前导码和分隔符

前导码的值为 7 字节的 0x55，0x55 用二进制表示就是 01010101b，也就是说前导码的意义就是驱动网络链路电平开始交替翻转，以标记帧的开始

分隔符的值为 0xD5，0xD5 用二进制表示就是 11010101b

以太网 PHY 在将数据编码为以太网物理链路层的位传输信号是从低位开始编码的，所以从信号链路的电平来看，就是先连续的产生 62 位 0 和 1 交替变化的电平，最后再以 2 位连续的高电平来标记以太网数据帧部分的到来

#### MAC 地址

以太网以 MAC 值来确定网络上的数据是否是传给该网卡的，如果数据中的 MAC 地址值与该网卡的 MAC 地址值相同，则该网卡会接收网络上的数据内容，否则就会忽略。

* 单播地址要求第一个字节的 bit0（即最先发出去的位）必须是 0
* 多播地址要求以太网帧中目的 MAC 地址第一个字节的 bit0 强制设置为 1，这样，在网络中多播地址不会与任何网卡的 MAC 相同，但此时网卡依旧会接收该数据帧，然后交由上层 IP 协议来解多播地址，也就是说多播数据可以被很多个网卡同时接收；
* 广播地址所有 48 位全为 1（即 FF-FF-FF-FF-FF-FF），同一局域网中的所有网卡可以接收广播数据包


48 位的 MAC 地址由两部分组成，其中前 24 位由 IEEE 批复提供，后 24 位则由设备厂商自行定义。

```sh
ipconfig –all
```

#### 数据和填充字段

为什么数据长度至少要 46个字节，最多不超过 1500个字节呢？要理解这个要求的由来，还要从以太网数据帧在网络上传输的原理说起。

首先来讲，以太网传输是不可靠的，这意味着发送方并不知道接收方有没有收到自己发出的数据包，如果他发出的数据包发生错误，就需要重传。

以太网的错误主要是发生碰撞，碰撞是指两台机器同时监听到网络是空闲的，同时发送数据，就会发生碰撞，碰撞对于以太网来说是正常但需要合理应对的。

```
       A
       │      
     ┌─┴─┐    
B ───┤hub├──── D
     └─┬─┘    
       │ 
       C     
```

假设 设备 A 向设备 D 发送数据，它的传输情况需要有以下的流程：

* 监听媒体使用情况（Carrier Sense）：A 主机在发送网络封包前，需要先对网络媒体进行监听，确认没有其他设备在使用后，才能够发送出讯框
* 多点传输 (Multiple Access)：A 主机所送出的数据会被集线器复制多份，然后传送给所有连接到此集线器的其他网络设备。也就是说，A 主机送出的数据，B、C、D 三个计算机都能够接收的到。但由于目标是 D 设备，因此 B 与 C 会将此讯框数据丢弃，而 D 设备则会抓下来处理；
* 碰撞侦测 (Collision Detection)：该讯框数据附有检测能力，在 A主机发送给数据过程中，若其他主机例如 B 计算机也刚好在同时间发送讯框数据时，那么A 与 B 送出的数据碰撞在一块（出车祸），此时这些讯框就会损毁，那么 A 与 B 就会各自随机等待一个时间，然后重新通过第一步再传送一次该讯框数据。
  
某一时刻，假设 A 检测到网络是空闲的，开始发数据包，尽力传输，当数据包还没有到达 B 时，B 也监测到网络是空闲的，开始发数据包，这时就会发生碰撞，B 首先发现发生碰撞，开始发送碰撞信号，所谓碰撞信号，就是连续的 01010101 或者 10101010，十六进制就是 55 或 AA。这个碰撞信号会返回到A，如果碰撞信号到达 A 时，A 还没有发完这个数据包，A 就知道这个数据包发生了错误，就会重传这个数据包。但如果碰撞信号返回到 A 时，数据包已经发完，则 A 不会重传这个数据包。

要保证以太网的重传，必须保证 A 收到碰撞信号的时候，数据包没有传完，要实现这一要求，A 和 B 之间的距离很关键，也就是说信号在 A 和 B 之间传输的来回时间必须控制在一定范围之内。

## ARP 数据帧

| 类别                        | 描述           | 字节数 | 默认值  |                                                                    |
| --------------------------- | -------------- | ------ | ------- | ------------------------------------------------------------------ |
| 14 字节以太网帧首部         | 目的MAC地址    | 6      |         | 发送 ARP 请求报文时，该值为广播地址                                |
|                             |                |        |         | （FF-FF-FF-FF-FF-FF）                                              |
|                             |                |        |         | 发送 ARP 应答报文时，该值为对应的发送请                            |
|                             |                |        |         | 求报文设备的实际 MAC 地址。                                        |
|                             | 源MAC地址      | 6      |         | 数据帧发送方 MAC 地址                                              |
|                             | 帧类型         | 2      | 0x0806  | 0x0806 是 ARP 帧的类型值                                           |
| 28 字节 ARP 请求/应答帧内容 | 硬件类型       | 2      | 0x0001  | 以太网类型值                                                       |
|                             | 协议类型       | 2      | 0x0800  | 上层协议为 IP 协议                                                 |
|                             | 硬件地址长度   | 1      | 0x6     | 以太网 MAC 地址长度为 6                                            |
|                             | 协议地址长度   | 1      | 0x4     | IP 地址长度为 4                                                    |
|                             | 操作码         | 2      | 0x1/0x2 | 0x1 表示 ARP 请求报文                                              |
|                             |                |        |         | 0x2 表示 ARP 应答报文                                              |
|                             | 发送端MAC地址  | 6      |         | 源 MAC 地址                                                        |
|                             | 发送端IP地址   | 4      |         | 源 IP 地址                                                         |
|                             | 目的以太网地址 | 6      |         | 发送 ARP 请求报文时，该值由于当前未知，用全 0 填充。               |
|                             |                |        |         | 发送 ARP 应答报文时，该值为对应的发送请求报文设备的实际 MAC 地址。 |
|                             | 目的 IP 地址   | 4      |         | 目的 IP 地址                                                       |
| 填充数据                    | 填充数据       | 18     |         | 因为物理帧最小长度为 64 字节,前面的 42 字                          |
|                             |                |        |         | 节再加上 4 个 CRC 校验字节,还差 18 个字节                          |
| 以太网校验                  | 校验字         | 4      |         | CRC32 校验值，以上所有数据参与校验的结果                           |

例如下面是一个 ARP 请求包和应答包示例:

| 数据帧字段          | ARP 请求帧        | ARP 应答帧        |
| ------------------- | ----------------- | ----------------- |
| 接收方 MAC          | ff_ff_ff_ff_ff_ff | 00_0a_35_01_fe_c0 |
| 发送方 MAC          | 00_0a_35_01_fe_c0 | 84_7b_eb_48_94_13 |
| 类型                | 08_06             | 08_06             |
| 硬件类型            | 00_01             | 00_01             |
| 协议类型            | 08_00             | 08_00             |
| MAC 地址长度        | 06                | 06                |
| IP 地址长度         | 04                | 04                |
| 操作代码            | 01                | 02                |
| 发送方 MAC          | 00_0a_35_01_fe_c0 | 84_7b_eb_48_94_13 |
| 发送方 IP           | C0_A8_00_02       | C0_A8_00_03       |
| 接收方 MAC          | 00_00_00_00_00_00 | 00_0a_35_01_fe_c0 |
| 接收方 IP           | C0_A8_00_03       | C0_A8_00_02       |
| 填充字段  (18 字节) | 18 个 00          | 18 个 00          |
| 校验字段 (4 字节)   | 由实际帧内容计算  | 由实际帧内容计算  |

## IP 协议

| 类别                 | 描述            | 字节数 | 默认值 |                                                         |
| -------------------- | --------------- | ------ | ------ | ------------------------------------------------------- |
| 14 字节以太网帧首部  | 目的MAC地址     | 6      |        | 发送 ARP 请求报文时，该值为广播地址                     |
|                      |                 |        |        | （FF-FF-FF-FF-FF-FF）                                   |
|                      |                 |        |        | 发送 ARP 应答报文时，该值为对应的发送请                 |
|                      |                 |        |        | 求报文设备的实际 MAC 地址。                             |
|                      | 源MAC地址       | 6      |        | 数据帧发送方 MAC 地址                                   |
|                      | 帧类型          | 2      | 0x0800 | 0x0800 是 IP 帧的类型值                                 |
|                      |                 |        |        |                                                         |
| IP 报文首部 (20字节) | IP 协议版本     | 4 bit  | 4/6    | IPV4 或者 IPV6                                          |
|                      | IP 首部长度     | 4 bit  |        | IP 首部长度即有多少个 32 位数, 当 IP 首部长度为 20 时   |
|                      |                 |        |        | （即无可选字段），该值为 5 (5*4 =20)                    |
|                      | 服务类型        | 1      | 0      | 指示了报文的优先权等, 简单的发送可以全部置 0 即可       |
|                      | IP报文总长度    | 2      |        | IP 报文（报头+数据）长度                                |
|                      | 分段标识        | 2      |        | 是否属于同一数据段，IP 报文的分段 ID                    |
|                      | 段标识和段偏移  | 2      |        | 简单的发送可以全部置 0 即可                             |
|                      | 生存周期 (TTL)  | 1      |        | 可以经过的最大路由数, 由源主机设置, 每次-1，一旦到0则   |
|                      |                 |        |        | 数据报就被丢弃, 并发送 ICMP 消息通知源主机              |
|                      | 上层协议类型    | 1      |        | 指该 IP 包中数据段内容所使用的网络协议类型，如 ICMP DNS |
|                      |                 |        |        | 常用协议号 00：IP, 01：ICMP, 06：TCP, 17：UDP           |
|                      | IP 报头的校验和 | 2      |        | 对 IP 报头计算得出                                      |
|                      | 源 IP 地址      | 4      |        | 发送端的 IP 地址                                        |
|                      | 目的 IP 地址    | 4      |        | 接收端的 IP 地址                                        |
| 可选字段             | 可选字段        | 0      |        | 没有的时候长度可以为 0                                  |
|                      |                 |        |        |                                                         |
| 以太网校验           | 校验字          | 4      |        | CRC32 校验值，以上所有数据参与校验的结果                |


## UDP 协议

| 类别 | 描述       | 字节数 | 默认值 |                                                |
| ---- | ---------- | ------ | ------ | ---------------------------------------------- |
|      | 源端口号   | 2      |        | 例如 5000 发送方的网络端口地址                 |
|      | 目的端口号 | 2      |        | 例如 6000 接收方的网络端口地址                 |
|      | UDP 长度   | 2      |        | UDP 报文（含数据）长度                         |
|      | UDP 校验和 | 2      |        | UDP 协议的报头和数据的校验和, 写 0x0000 可忽略 |
|      | UDP 数据   | n 字节 |        |                                                |


## ICMP 

| 类别 | 描述   | 字节数 | 默认值                          |     |
| ---- | ------ | ------ | ------------------------------- | --- |
|      | 类型   | 1      | 8: 请求, 0: 回复, 3: 目标不可达 |     |
|      | 代码   | 1      |                                 |     |
|      | 校验和 | 2      |                                 |     |
|      | 标识符 | 2      | 应该和请求一致                  |     |
|      | 序列号 | 2      |                                 |     |
|      | 数据包 | n 字节 |                                 |     |


