---
mytags: myblog
title: 01USB概述及协议基础
date: 2023-03-02 19:53:59
categories: [Book, 圈圈教你玩转USB]
tags: [USB]
---

本文主要介绍USB的基本概念和基础知识
<!-- more -->


### USB 

[USB 中文网](https://www.usbzh.com/) 有很多资料, 很实用哦.

USB 是通用串行总线 (Universal Serial Bus) 的缩写.


| 版本                                                     | 理论最高速度          |
| -------------------------------------------------------- | --------------------- |
| USB 1.0 Low Speed                                        | 1.5Mb/s 或 0.1875MB/s |
| USB 1.0 Full Speed                                       | 12Mb/s 或 1.5MB/s     |
| USB 1.1 (即 USB 1.0 Full Speed)                          | 12Mb/s 或 1.5MB/s     |
| USB 2.0 Full Speed（即USB 1.1）                          | 12Mb/s 或 1.5MB/s     |
| USB 2.0 High Speed                                       | 480Mb/s 或 60MB/s     |
| USB 3.0                                                  | 5Gb/s 或 600MB/s      |
| USB 3.1 Gen 1 （即USB 3.0）                              | 5Gb/s 或 600MB/s      |
| USB 3.1 Gen 2                                            | 10Gb/s 或 1250MB/s    |
| USB 3.2 Gen 1（即USB 3.1 Gen 1）                         | 5Gb/s 或 600MB/s      |
| USB 3.2 Gen 2（即USB 3.1 Gen 2）                         | 10Gb/s 或 1250MB/s    |
| USB 3.2 Gen 2×2（即USB 3.1 Gen 2双通道，仅限Type-C接口） | 20Gb/s或2500MB/s      |
| USB 4 （仅限Type-C接口）                                 | 40Gb/s 或 5000MB/s    |
| 雷电1代 (Thunderbolt 1)                                  | 10Gb/s 或 1250MB/s    |
| 雷电2代（Thunderbolt 2）                                 | 20Gb/s或2500MB/s      |
| 雷电3代（Thunderbolt 3）                                 | 40Gb/s 或 5000MB/s    |

### USB 拓扑结构

USB 是一种主从结构的系统, 主机叫做 Host, 从机叫做 Device (也叫做设备).

主机一般有一个或多个`主控制器(host controller)` 和 `根集线器(root hub)`. 主控制器主要负责数据处理, 而根集线器则提供主机和设备之间的接口和通路.

有一类特殊的 USB 设备 -- USB 集线器 (USB hub), 它可以在原有的 USB 口上扩展出更多的 USB 口, 但是需要注意的是: **集线器只能扩展出更多接口的USB口，而不能扩展出更多的带宽。带宽是共享同一个USB主控制器的。** 因此当有多个不同的 USB 设备都需要较大的数据带宽时, 可以考虑将它们分别连接到不同的主控制器的根集线器上以避免带宽不足.

级连的 USB 集线器的层数也是有限制的, USB1.1 规定最多级连4层, USB 2.0 规定最多级连6层. 理论上， 一个 USB 主控制器最多可接 127 个设备, 因为协议规定每个 USB 设备具有一个 7bit 的地址 (取值范围 0 ~ 127， 而 0 是保留给未是初始化设备使用的)

一个完整的 USB 数据传输过程如下:

先由 USB 主控制器发出命令和数据, 通过集线器发给 USB 设备, 设备对接收到的数据进行处理, 再通过集线器发送给主机. 在标准的 PC 中, USB 主控制器是直接挂接在 PCI 总线上的.

在 Windows 中, 各个 USB 功能的驱动程序负责产生和管理 USB 功能设备 (FDO), 这就是我们最终看到的实际设备。

### USB 电气特性

标准的 USB 为 4 线: `VBUS`、`D+`、`D-` 以及 `GND`.

USB 的主从模式的结构也就意味着, 从机与从机、主机与主机之间不能直接互连和交换数据. 由此出现了 USB OTG (On The Go), 即让同一个设备, 在不同的场合下可以在主机和从机之间切换. 

> USB OTG 的接头 (比如 USB MINI 头) 比普通的 4 线 USB 多了一条 ID 标识线, 用来表明它是主机还是设备.

USB 使用的是 NRZI 编码方式, 一般芯片内置, 具体过程略.

USB 协议规定 (USB 3.0之前) 设备未配置前, 可以从 VBUS 上最多获取 100mA 的电流, 配置后最多获取 500mA.


USB 各种接头规格参考这篇[文章](https://zhuanlan.zhihu.com/p/447595295)

### USB 插入检测机制

USB 集线器每个端口的 D+ 和 D- 分别接 15kΩ 的下拉电阻, 而设备端在 D+ 或 D- 接 1.5kΩ 的上拉电阻. 当设备插入时, 集线器端口的数据线由默认的低电平转为高电平, 集线器检测到这个状态后, 它就报告给上一层集线器最终传递给主机, 从而识别设备插入.

对于低速设备, 上拉电阻接在 D-, 对于全速或高速, 上拉电阻接在 D+, 高速先被识别为全速, 再由集线器和设备相互确认后切换到高速模式. 另外, 因为高速模式是电流传输模式, 这时要将 D+ 上的上拉电阻断开.

> 一个实验, 用 10k 电阻接在 USB 5V  和 D+  或 D-, Windows 会提示发现新硬件, 但是无法识别设备. 这时因为 D+ 或 D- 被拉高, 集线器认为有设备插入了,  它就报告给主机, 但是主机请求获取数据却没有响应, 就会得到一个无法识别的 USB 设备. 这时设备管理器里面显示一个未知设备, 并且其 `VID` 和 `PID` 都是 0.
> 
> `VID` 和 `PID` 是设备在设备描述符中规定的, 在调试时如果发现 VID 和 PID 都为 0, 那么很可能设备什么都没返回.

一些 USB 芯片内部已经集成了一个 1.5kΩ 的上拉电阻， 并且还具有软连接功能, 可通过软件来实现上拉电阻的连接和断开, 这样就可以做到通过软件断开或重连 USB , 而 USB口 实际一直在插着供电. 

### USB 的描述符及其之间的关系

主机通过描述符来识别和处理设备, 描述符中记录了设备类型, 厂商 ID 和产品 ID (通常依赖它们来加载对应的驱动程序)、端点情况、版本号等.

USB 1.1 协议定义的标准描述符有:

* 设备描述符 (Device Descriptor)
* 配置描述符 (Configuration Descriptor)
* 接口描述符 (Interface Descriptor)
* 端点描述符 (End-point Descriptor)
* 字符串描述符 (String Descriptor)

USB 2.0 又新增了 2 个标准描述符:

* 设备限定符描述符 (Device Qualifier Descriptor)
* 其他速度配置描述符 (Other Speed Configuration Descriptor)

另外还有一些特殊的描述符, 例如类特殊描述符 (如 HDI 描述符和音频接口描述符), 厂商自定义的描述符等.

#### 1. 描述符的内容

一个USB设备只有一个设备描述符。设备描述符里决定了该设备有多少种配置，每种配置都有一个配置描述符；而在每个配置描述符中又定义了该配置里有多少个接口，每个接口都有一个接口描述符；在接口描述符里又定义了该接口有多少个端点，每个端点都有一个端点描述符；端点描述符定义了端点的大小、类型等。如果有类特殊描述符，它跟在相应的接口描述符之后。

由此可以看出，USB的描述符之间的关系是一层一层的，最上一层是设备描述符，接下来是配置描述符，再下来是接口描述符，最下面是端点描述符。

下面是每种类型描述符的主要内容:

* **设备描述符**：USB协议版本号、设备类型、端点0的最大包大小、厂商ID（VID）和产品ID（PID）、设备版本号、厂商字符串索引、产品字符串索引、设备序列号索引、可能的配置数等。
* **配置描述符**：配置所包含的接口数、配置的编号、供电方式、是否支持远程唤醒、电流需求量等。
* **接口描述符**：接口的编号、接口的端点数、接口所使用的类、子类、协议等。
* **端点描述符**：端点号及方向、端点的传输类型、最大包长度、查寻时间间隔等。
* **字符串描述符**: 主要是提供共一些方便人们阅读的信息，它不是必需的。

在主机获取描述符时，首先获取设备描述符，接着再获取配置描述符，然后根据配置描述符中的配置集合的总长度，一次将配置描述符、接口描述符、类特殊描述符（如果有）、端点描述符一次读回。

对于字符串描述符，是单独获取的。主机通过发送获取字符串描述符的请求以及描述符的索引号、语言ID来获取对应的字符串描述符。

#### 2. 描述符与设备的关系

每个接到集线器上的 USB 设备都分配有一个独立的地址, USB 主机通过该地址来访问设备 (类似于计算机网络中的 IP 地址), 而在设备内部有可能还会分出多个通信端点 (类似于计算机网络中的端口), 每个端点都有自己的端点号. 要向设备发送或读取数据, 就需要像计算机网络那样, 同时给出设备地址和端点号.

与计算机网络不同的是, USB设备种类众多, 每种设备的端点数量和通信方式都不同, 为了更方便得管理这些零散的端点, USB 协议抽象出了配置和接口的概念. 它是这样管理的:

###### 设备和接口对端点的管理

一个设备可以有多个配置, 但是同一时刻只能有一个配置有效, 当我们需要不同的功能时, 只要选择不同的配置即可.

每个配置下可以有多个接口, 每个接口就是一些端点的集合, 它被定义为一种功能, 例如U盘、USB声卡、USB串口等. 根据功能的不同接口下的端点数也不同. 并且多个接口可以同时有效, 这种情况一般被称为**复合设备**, 例如一个 USB 设备同时具有声卡和串口功能, 声卡功能用来传输音频, 而串口则用来对声卡设备进行控制.

端点数量是唯一的, 根据不同的配置策略, 它们被组织到不同的接口, 呈现出不同的功能.

