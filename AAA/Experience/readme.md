

踩过的【坑】:

## C

1. 数据通信进行拼接时，注意 buf 类型最好不要选择 char, 而是应当选择 uint8_t, 否则拼接类似 
   uint32_t val = (buf[3] << 24) | (buf[2] << 16) | (buf[1] << 8) | (buf[0] << 0)
   因为 char 有符号，移位时会保留符号位导致出错。

## STM32

1. 板子上有两片 stm32, 一个是 f405, 一个是 f413, 没看清楚是哪个芯片就开始接线调试，搞半天发现调的芯片错了, f413 的程序可以直接下载到 f405, 
   但是初始化 I2S3 口时时钟总是出错，无法初始化成功。拿 H7 的代码同样配置可以跑通，于是怀疑是官方代码有问题，研究初始化阶段到底是哪里有问题，用 H7 代码对照着看，
   最后虽然能初始化通过，但是不好。根本原因是没有及时发现调试的芯片压根对不上。

2. USB 识别不成功，同样是因为调错芯片，RCC 外部晶振配置出错，两个芯片的晶振时钟不一样，一个是 8MHz, 另一个是 12.288M, 是为了方便音频同步所以直接使用12.288M 作为系统时钟源。

3. 2025-11-11 15:42:16 晶振导致 usb 音频传输数据不连续 (坑耗时7days)
   在板子上调试 f413 usb 音频时, 一开始使用 CherryUSB，16000Hz采样率和16bit时发送模拟的数据发现是好的，然后一到48000Hz或32bit就一直数据有问题，通过发送生成的正弦波数据，在Au上采集数据
   打开频率分析，发现频率不连续。怎么调都不对，换成TinyUSB库依然不对，这时使用TinyUSB的例程，放在H750开发板上都是正常的。中间有一个坑点还导致误判，浪费很多时间，就是如果 usb 音频支持配置
   多种采样频率和位深度，那么需要在Windows设置中需要选择对应的采样频率和位深度，这时使用Au进行录音时才会选择给定的配置进行录音，如果烧录另一种配置usb声卡，而仍停留在设置界面，则使用Au进行录音时会报硬件错误。
   需要在设置界面进行更新才行，所以最好先在Windows设置界面先测试音频是否正常，在使用Au进行录音就不会有问题了。
   一开始以为是H7处理器频率高，而F413处理不过来导致的，但是尝试使用F103测试，发现依然是可以流畅传输数据，只是多通道和多配置有一些问题。最终根据Cubemx时钟配置时，发现时钟有些不对劲，查看原理图，
   发现F413晶振是12.288M的音频晶振，开始怀疑分频给 USB2.0 的 48M 似乎是有问题的，也可能是 12.288M 晶振导致系统定时器1ms是不精确的，因为抓包发现每个音频包发送 192 字节，但是每隔几个包就变成 196 字节了，
   正是因为这个原因导致正弦波频率不连续。要么是丢包，要么是多包，而这次是多包，每隔一段时间就会多出4字节的数据，导致数据有问题。于是开始排查，换成8MHz的有源晶振，发现问题解决了。

4. 2025-12-22 17:20:08 串口 DMA 发送失败 (耗时半天)
   尝试使用 Cubemx 生成 Makefile 的工程时, 在 ART-PI 上使用串口 DMA 发送, 但一直没有进入 DMA 发送完成中断, 单步进入 HAL_DMA_IRQHandler()，发现进入了错误处理分支，可是工程代码完全是
   和 Keil工程一样。排查很久，才发现生成的 ld 脚本默认使用了 DTCMRAM，而不是 512KB 的 RAM_D1，这部分内存是不支持 DMA 的，所以出现总线错误。修改 ld 脚本后正常触发DMA完成中断。
   其实如果最开始注册了DMA错误中断，或许就能及时发现问题。
